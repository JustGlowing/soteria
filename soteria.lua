-- title:  game title
-- author: game developer
-- desc:   short description
-- script: lua

frames = 0

function solid(x, y)
  return solids[mget((x)//8, (y)//8)]
end

function init()
  solids={[33]=true, [34]=true, [49]=true, [50]=true}

  score=0
  mode='menu'

  p={
    x=120, 
    y=20, 
    sprite1=3, 
    sprite2=1, 
    w_sprite=2, 
    h_sprite=2, 
    w=2*8-1, 
    h=2*8-1, 
    vx=0, --Velocity X
    vy=0, --Velocity Y
    colorkey = 0, 
    orientation = 1, 
    kick=false
  }  
  place_lems(60, 20, 10)
  frames=0
end

function place_lems(start_x, start_y, step)
  lems={}
  for i=0, 9 do
    start_x=start_x+step
    local lem={
      x=start_x, 
      y=start_y, 
      vx=.5, 
      vy=0, 
      orientation = 1, 
      sprite1=9
    }
    table.insert(lems, lem)
  end
end

function debug_print()
  rect(p.x, p.y, 1, 1, 6)
  rect(p.x+p.h, p.y, 1, 1, 5)
  rect(p.x, p.y+p.w, 1, 1, 5)
  rect(p.x+p.h, p.y+p.w, 1, 1, 5)
  rect(p.x+7+p.vx, p.y+p.vy, 1, 1, 5)
  rect(p.x+p.w+p.vx, p.y+7+p.vy, 1, 1, 5)
  rect(p.x+7+p.vx, p.y+p.w+p.vy, 1, 1, 6)
  rect(p.x+p.vx, p.y+7+p.vy, 1, 1, 5)

  print(tostring(p.x) .. ", " .. tostring(p.y .. ", " .. tostring(p.orientation)), 0, 0)
  for _, lem in ipairs(lems) do
    rect(lem.x, lem.y, 1, 1, 6)
  end
end

function update_lem()
  to_remove = {}

  for i, lem in ipairs(lems) do
    if solid(lem.x+lem.vx, lem.y+lem.vy)
    or solid(lem.x+lem.vx, lem.y+7+lem.vy) then
      if lem.vy==0 then
        lem.vx=.5
        lem.orientation=1
      end
    end

    if solid(lem.x+7+lem.vx, lem.y+lem.vy) or
    solid(lem.x+7+lem.vx, lem.y+7+lem.vy) then
      if lem.vy==0 then
        lem.vx=-.5
        lem.orientation=0
      end
    end

    if solid(lem.x, lem.y+8+lem.vy)
    or solid(lem.x+7, lem.y+8+lem.vy) then
      lem.vy=0
    else
      lem.vy=lem.vy+0.2
    end

    if lem.vy<0 and (solid(lem.x+lem.vx, lem.y+lem.vy)
    or solid(lem.x+7+lem.vx, lem.y+lem.vy)) then
      lem.vy=0
    end

    if p.kick and p.orientation==0
    and math.abs(lem.x-p.x)<8 and math.abs(lem.y-p.y-8)<8 then
      --sfx(0, 60, 8)
      lem.vy=-3.
      lem.vx=-1.
      lem.orientation=p.orientation
    end

    if p.kick and p.orientation==1
    and math.abs(lem.x-(p.x+p.w))<8 and math.abs(lem.y-p.y-8)<8 then
      --sfx(0, 60, 8)
      lem.vy=-3.
      lem.vx=1.
      lem.orientation=p.orientation
    end

    lem.x=lem.x+lem.vx
    lem.y=lem.y+lem.vy

    if lem.y > 128 then
      score=score+1
      lem.x=10
      lem.y = 0
      --table.remove(lems, i)
    end
  end
end

function update_player()
  p.kick=false
  if btn(2) then
    p.vx=-1
    p.orientation = 0
  elseif btn(3) then
    p.vx=1
    p.orientation = 1
  else
    p.vx=0
  end

  if solid(p.x+p.vx, p.y+p.vy)
  or solid(p.x+p.w+p.vx, p.y+p.vy)
  or solid(p.x+p.vx, p.y+p.h+p.vy)
  or solid(p.x+p.w+p.vx, p.y+p.h+p.vy)
  or solid(p.x+7+p.vx, p.y+p.vy)
  or solid(p.x+p.w+p.vx, p.y+7+p.vy)
  or solid(p.x+p.vx, p.y+7+p.vy)
  then
    p.vx=0
  end

  if solid(p.x, p.y+p.h+p.vy+1)
  or solid(p.x+p.w, p.y+p.h+p.vy+1)
  or solid(p.x+7+p.vx, p.y+p.h+1+p.vy) then
    p.vy=0
  else
    p.vy=p.vy+0.2

  end

  if p.vy==0 and btnp(4) then
    sfx(0, 60, 8)
    p.vy=-2.5
  end

  if btnp(5) then
    sfx(0, 60, 8)
    p.kick=true
  end

  if p.vy<0 and (solid(p.x+p.vx, p.y+p.vy)
  or solid(p.x+p.w+p.vx, p.y+p.vy)) then
    p.vy=0
  end

  p.x=p.x+p.vx
  p.y=p.y+p.vy
end

function draw_sprites()
  spr(p.sprite2, p.x, p.y, p.colorkey, 1, p.orientation, 0, p.w_sprite, p.h_sprite)
  for i, lem in pairs(lems) do
    spr(9+(frames%60//30*2)/2, lems[i].x, lems[i].y, lems[i].colorkey, 1, lems[i].orientation, 0)
  end
  print("score " .. tostring(score), 10, 0)
end

init()
function TIC()
  frames = frames + 1
  if mode == 'game' then
    update_player()
    update_lem()
    cls()
    map()
    draw_sprites()
  end

  if mode == 'menu' then
    cls()
    map(0, 17)    
    print('Press X to start', 20, 20)
    if btnp(5) then
      mode='game'
      place_lems(60, 20, 10)
    end
  end
  --debug_print()
end

-- <TILES>
-- 000:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
-- 001:000eeeee00eeeeee0eeeeeee0ecccccc0effffff0cff2fff0cff2fff0cff2fff
-- 002:eeeee000e66e6600e6666600c66666e0f66c66e02ffceee02ffceee02ffceee0
-- 003:000eeeee00eeeeee0eeeeeee0ecccccc0effffff0cff2fff0cff2fff0cff2fff
-- 004:eeeee000e66e6600e6666600c66666e0f66c66e02ffceee02ffceee02ffceee0
-- 005:0000000000033fff0033ffff033fffff0fffffff0fff2fff0ff2f2f20fffffff
-- 006:00000000fff00c00ffff0cc0ffffc000ffffff002fffff30f2fff330ffff3330
-- 007:0000c00000000c00077003337ff73fff07f377ff003773ff0377373f03ffffff
-- 008:000c000000c0000033300770fff37ff7ffff3f70ff3ff300f3f3ff30ffffff30
-- 009:0bbbbbb0bbbbbbbbb2fbb2fbbffbbffbbbb2bbbb0bbbbbb000c00c6006600060
-- 010:0bbbbbb0bbbbbbbbb2fbb2fbbffbbffbbbb2bbbb0bbbbbb0000c0c0000666600
-- 016:cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
-- 017:0cffffff0ccccccc0ccc6ccc0cccc6660ccccccc022222220022200000111000
-- 018:fffceee0cccceee06ccceee0cccceee0cccceee0222200002220000011100000
-- 019:0cffffff0ccccccc0ccccc6c0ccccc6c0ccccccc022222220022200000111000
-- 020:fffceee0cccceee0cccceee0cccceee0cccceee0222200002220000011100000
-- 021:0fffffff0fffffff0fcccccc0cc3cccc0ccccccc00cccccc00fff00000333000
-- 022:ffff3330fffff330ccffff303ccffff0cccfff00ccff0000fff0000033300000
-- 023:03ffffcc00ffcc6c003fcccc000376cc003ff76603ffff77034444f303444430
-- 024:ccffff30c6ccff00ccccf300cc673000667ff30077ffff303f14443003144430
-- 033:effffffdfdddddddfdddddddfdddddddfdddddddfdddddddfddddddddddddddd
-- 034:aaaaaaadadddddddadddddddadddddddadddddddadddddddaddddddddddddddd
-- 035:aaaaaaaaaaaaaaaaa66aa664a2266224a6622664aaa66aa4aaaaaaa4aaaaaaa4
-- 049:aaaaaaadadddddddadddddddadddddddadddddddadddddddaddddddddddddddd
-- 050:aaaaaaadadddddddadddddddadddddddadddddddadddddddaddddddddddddddd
-- </TILES>

-- <MAP>
-- 000:120202020202020202020202020202020202020202020202020202020212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:121212121212121212121212121212121212121212121212121212121212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:120000000000121200121200121200121200121200000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:120000000000000000000000000000000000000000000000120000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:120000000000000012121212121212121212121212121212120000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:120000000000121200000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:120000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:120000000000000000000000000000000000000000000000000032000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:120012120000000000000000000000000000000000000000000012000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:121212120000000000000000000000000000000000000000000012000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:121212121212121212121212121212121212121212121212121212120012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 027:000022222200002200002222220022222200222200002200002200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 028:000022000000220022000022000022000000220022002200220022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 029:000022222200220022000022000022222200222200002200220022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 030:000000002200220022000022000022000000220022002200222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 031:000022222200002200000022000022222200220022002200220022000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- 003:54323456765432101234567876543234
-- </WAVES>

-- <SFX>
-- 000:0350036003700380039003a003b003c003d003e003e003f003f003e003e003d003d003c003b003a00390038003700360035003400330032003100300302000000000
-- </SFX>

-- <PALETTE>
-- 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
-- </PALETTE>

